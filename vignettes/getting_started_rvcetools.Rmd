---
title: "Getting Started with rvcetools"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting Started with rvcetools}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup, eval=FALSE}
library(rvcetools)
```


## Disclaimer
The package `rvcetools` is used to post-process and to work with results from programs that do variance components estimation (vce). Initially, we limit our focus for result files from the program called `VCE`. 


## Background
Variance component estimation is the process of estimating scale parameters such as variance components from data. The parameter estimation uses linear mixed models to define the set of different random effects to which the observed variation should be attributed to. 

Linear mixed effects models recently have gained some popularity outside of the area of animal breeding. But still there are not standard software packages around that can estimate variance components for very large datasets. Therefore, specialized softare programs are used for this task. These programs do not provide any features outside of the parameter estimation functionality. As a consequence of that results from the specialised programs must be read into systems such as R to do bending, plotting or other post-processing tasks. 


## Features
The most central feature is to read in raw outfiles from the different variance components estimation programs. In the most basic case there is only one output file from one analysis. In more advanced analyses, there might be output files from repeated analyses of different sample data sets. 


## Datastructures


## Functionalities
When it comes to processing outputs of variance components estimation, it is useful to transform variance-covariance matrices into correlation matrices and the other way around. In most practical calses the matrices are small and hence a solution via iterative loops should be ok. An example is shown here

```{r}
(mat_vcov <- matrix(c(104,75,18,75,56,12,18,12,7), nrow = 3, byrow = TRUE))
```

Convert this into a matrix of correlations is done with the following two nested loops

```{r}
n_nr_trait <- nrow(mat_vcov)
mat_cor <- diag(x = 0.5, nrow = n_nr_trait)
for (i in 1:(n_nr_trait-1)){
  for (j in (i+1):n_nr_trait){
    mat_cor[i,j] <- mat_vcov[i,j] / sqrt(mat_vcov[i,i] * mat_vcov[j,j])
  }
}
(mat_cor <- mat_cor + t(mat_cor))
```


The reverse conversion needs also the standard deviations or the variances as input

```{r}
mat_comp_cov <- diag(x = 0, nrow = n_nr_trait)
vec_var <- diag(mat_vcov)
for (i in 1:(n_nr_trait-1)){
  for (j in (i+1):n_nr_trait){
    mat_comp_cov[i,j] <- mat_cor[i,j] * sqrt(vec_var[i] * vec_var[j])
  }
}
mat_comp_cov <- mat_comp_cov + t(mat_comp_cov)
diag(mat_comp_cov) <- vec_var
mat_comp_cov
```

Compare this to the function `cov2cor``

```{r}
cov2cor(mat_vcov)
```

